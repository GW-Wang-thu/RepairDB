{% extends 'datasubmit_template.html' %}
{% load static %}

{% block content %}

    <div class="container">
        <div class="panel panel-default">
            <div class="panel-body">
                 <form method="post" novalidate>
                      <div class="form-group">
                            <label>损伤结构</label>
                            <select name="structure_type" class="form-control" placeholder="损伤结构" required="" id="id_structure_type">
                              <option value="" selected="">所有结构</option>
                              <option value="0">层合板</option>
                              <option value="1">蜂窝结构</option>
                              <option value="2">加筋结构</option>
                              <option value="3">挖补/贴补/螺栓修复结构</option>
                            </select>
                      </div>
                      <div class="form-group">
                            <label>无损检测方法</label>
                            <select name="ndt_method" class="form-control" placeholder="无损检测方法" required="" id="id_ndt_method">
                              <option value="" selected="">所有方法</option>
                              <option value="0">目视检测</option>
                              <option value="1">超声C扫+A扫</option>
                              <option value="2">主动热成像</option>
                              <option value="3">X-CT</option>
                              <option value="4">激光剪切散斑</option>
                              <option value="5">形貌重建</option>
                              <option value="6">其他方法</option>
                            </select>
                            <span style="color: red;"></span>
                      </div>
                      <div class="form-group">
                            <label>损伤类型</label>
                            <select name="damage_type" class="form-control" placeholder="损伤类型" required="" id="id_damage_type">
                              <option value="" selected="">所有类型</option>
                              <option value="0">蒙皮分层（可能由于制造原因、载荷集中、低速冲击、老化疲劳等导致的不明原因分层）</option>
                              <option value="1">长桁分层（可能由于制造原因、载荷集中、低速冲击、老化疲劳等导致的长桁分层）</option>
                              <option value="2">蒙皮-芯材/长桁/筋条胶接面脱粘（蜂窝或加筋结构蒙皮-芯材/筋连接处脱粘）</option>
                              <option value="3">蜂窝进水（蜂窝结构内部进水）</option>
                              <option value="4">表面割裂损伤或深划痕（面板表面若干层被割伤）</option>
                              <option value="5">腐蚀/老化（蜂窝芯，或基体、纤维材料老化腐蚀失效）</option>
                              <option value="6">雷击损伤</option>
                              <option value="7">功能损伤（涂层老化脱落等导致的吸波功能减退等）</option>
                              <option value="8">制造缺陷（夹杂、纤维堆叠、褶皱等）</option>
                              <option value="9">过载断裂（超载、碰撞等局部应力过大导致的断裂）</option>
                              <option value="10">低速冲击损伤（表面凹痕、内部分层及裂纹）</option>
                              <option value="11">高速冲击损伤（穿透/非穿透型冲击孔）</option>
                              <option value="12">其他损伤</option>
                            </select>
                            <span style="color: red;"></span>
                      </div>
                    <button type="button" class="btn btn-primary" id="id-button-query">筛选</button>
                </form>
            </div>
        </div>

        <div class="panel panel-default" id="id-panel-img">
            <div class="panel-heading">损伤图谱</div>
            <div class="panel-body" id="id-body-img">
            </div>
        </div>
    </div>

{% endblock %}

{##}
{% block js %}
    <script type="text/javascript">
        $.ajaxSetup({
            data: {csrfmiddlewaretoken: '{{ csrf_token }}'}
        });

        $(function (){
            query_event('init')
            var submit_button = document.getElementById('id-button-query')
            submit_button.onclick = query_event
        })

        function query_event(message) {
            // log 一下
            var structure_type = document.getElementById('id_structure_type').selectedIndex
            var ndt_method = document.getElementById('id_ndt_method').selectedIndex
            var damage_type = document.getElementById('id_damage_type').selectedIndex

            $.ajax({
                url: "/data-service/damage_map/",
                type: "post",
                data: {
                    "structure_type": structure_type,
                    "ndt_method": ndt_method,
                    "damage_type": damage_type
                },
                success: function (res) {
                    // 更新损伤图谱
                    {#console.log(res)#}
                    var display = document.getElementById('id-body-img')
                    while (display.firstChild) {
                        display.removeChild(display.firstChild)
                    }
                    for (i=0; i<res.num_items; i++) {
                        var tmp_img_title = res.fed_imgs[i].title
                        var tmp_img_descrip = res.fed_imgs[i].description
                        tmp_root = res.fed_imgs[i].imgdir
                        var tmp_img_dir = '../../imgs/' + tmp_root
                        var tmp_title_label = document.createElement('h3')
                        var tmp_descrip_label = document.createElement('p')
                        var tmp_img_html = document.createElement('img')
                        var tmp_caption_div = document.createElement('div')
                        var dmap_item_div = document.createElement('div')
                        console.log(tmp_img_dir)
                        tmp_caption_div.className = 'caption'
                        tmp_title_label.innerText = tmp_img_title
                        tmp_descrip_label.innerText = tmp_img_descrip
                        tmp_caption_div.appendChild(tmp_title_label)
                        tmp_caption_div.appendChild(tmp_descrip_label)
                        tmp_img_html.src = tmp_img_dir
                        tmp_img_html.className = "img-responsive"
                        tmp_img_html.alt = "Responsive image"
                        dmap_item_div.className = 'thumbnail'
                        dmap_item_div.appendChild(tmp_img_html)
                        dmap_item_div.appendChild(tmp_caption_div)
                        display.appendChild(dmap_item_div)
                    }
                }
            })
        }

    </script>
{% endblock %}
